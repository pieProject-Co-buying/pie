<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/chatting}">

<div layout:fragment="chatContent" class="col">
	



	<div class="container-fluid">
	
		<div class="row">
		
			<div class="col">
			

			
				<div id="container" class="container">
				
				
					
					<h1 class="mb-5 text-center text-md-left">함께해요 파이채팅</h1>
					
					<div class="row mb-3">
					
						<div class="col">
							<input type="hidden" id="sender_id" th:value="${session.userId}">
							<input type="hidden" id="sessionId" th:value="${session.nickName}">
							<div id="chating" class="chating border py-2 px-2 rounded shadow"></div>							
						
						</div>
					
					</div>
					
					
					
					<div id="yourName" class="row">


						<div class="inputTable col-9">
								
							<!-- 대화명은 세션 아이디로 시작 -->
							<input type="text" name="chat_sender" id="userName" placeholder="" class="form-control"  th:value="${session.nickName}"  readonly >

							
							
						</div>
						
						<div class="inputTable col-3">
						
							<button onclick="chatName()" id="startBtn" class="btn pie-btn-red w-100" >시작</button>

						</div>
	

					</div>
					
					
					
	
					
					<div id="yourMsg" class="row">
					
					
						<div class="inputTable col-9">

							<input id="chatting" type="text" placeholder="보내실 메시지를 입력하세요." class="form-control" name="chat_messages">

						</div>
						
						<div class="inputTable col-3">
						
							<button onclick="send()" id="sendBtn" class="btn pie-btn-red w-100">전송</button>

						</div>
						
					</div>
					
				
					
				</div>
							
						
	
		<!-- 메모 
		
		채팅창 옆에 대화목록 보여지게 해야함... 레이아웃에서 수정..?
		레이아웃에 
		
		파라미터  roomName은 대화할 상대로 받을 것
		
		
		
		-->
		
		
		
			
			</div>	<!-- col -->
		
		</div>	<!-- row -->
	
	</div>  <!-- container-fluid -->



	<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->
	<!-- 카드크기 줄이고싶어요!!!!! 카드로 해야 깔끔한 카드로 줬어요 -->
	<!-- max-width 화면 %로 지정하고 글씨 갯수에 따라 늘어나게 하고 싶어요 카카오톡 처럼요 -->
	<!-- 이렇다면 div줘도 상관없을듯 하긴하네요 -->



	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>


	
	
	<script type="text/javascript">

	
	
		var ws;
	
		function wsOpen(){
			ws = new WebSocket("ws://" + location.host + "/chating");
			wsEvt();
		}
			
		
		
		// WebSocket 서버 URL
		var webSocketUrl = "ws://localhost:8080/socket";

		// WebSocket 연결
		var ws = new WebSocket(webSocketUrl);

		// WebSocket 연결이 열렸을 때 실행되는 함수
		ws.onopen = function(event) {
		    console.log("WebSocket 연결이 열렸습니다.");
		};

		// WebSocket 서버로부터 메시지를 받았을 때 실행되는 함수
		ws.onmessage = function(event) {
		    console.log("서버로부터 메시지를 받았습니다: " + event.data);
		    // 받은 메시지를 채팅창에 표시하는 등의 처리를 할 수 있습니다.
		};

		// 채팅 메시지를 전송하는 함수
		function sendMessage() {
		    var message = $("#chatInput").val(); // 채팅 입력창에서 메시지를 가져옴
		    ws.send(message); // WebSocket을 통해 메시지를 서버로 전송
		    $("#chatInput").val(""); // 메시지를 전송한 후 입력창을 비움
		}
		
		
		
		function wsEvt() {
			ws.onopen = function(data){
				//소켓이 열리면 동작
			}
			
			
			/* 수신시 동작하는 이벤트 핸들러 */
			ws.onmessage = function(data) {
				
				//메시지를 받으면 동작
				var msg = data.data;
				
				if(msg != null && msg.trim() != ''){
					
					var d = JSON.parse(msg);
					
					if(d.type == "getId"){
						
						var si = d.sessionId != null ? d.sessionId : "";
						
						if(si != ''){
							$("#sessionId").val(si); 
						}
						
					} else if(d.type == "message"){
						
						
						/* 세션아이디 일치 ==> 내가 입력할시 */
						if(d.sessionId == $("#sessionId").val()){
							$("#chating").append("<div class='me d-flex w-100 justify-content-end my-2'><div class='chatBallon rounded bg-warning py-2 px-3 d-flex flex-wrap text-wrap text-break'><p class='w-100'>" + d.msg + "</p></div></div>");	
						
							
						/* 세션아이디 불일치 ==> 상대방 입력할시 */
						} else {
							$("#chating").append("<div class='others w-100 text-left my-2'><div class='mb-2'>" + d.userName + "</div><div class='chatBallon rounded bg-info py-2 px-3 d-flex flex-wrap text-wrap text-break'><p class='w-100'>" + d.msg + "</p></div></div>");
						}
							
						
					} else{
						
						console.warn("unknown type!")
					}
		
				}
				
				
				
			}
	
			document.addEventListener("keypress", function(e){
				if(e.keyCode == 13){ //enter press
					send();
				}
			});
		}
		
		
		
		
	
		function chatName(){
			
			
			
			var userName = $("#userName").val();
			
			if(userName == null || userName.trim() == ""){
				alert("로그인해주세요");
				$("#userName").focus();
				
			} else {
				wsOpen();
				$("#yourName").hide();
				$("#yourMsg").css("display", "flex");
			}

		}
	
		
		
		
		function send() {
			
			
			var option = {
				type: "message",
				sessionId : $("#sessionId").val(),
				userId : $("#sender_id").val(),
				userName : $("#userName").val(),
				msg : $("#chatting").val()
			}
			
			ws.send(JSON.stringify(option))
			$('#chatting').val("");
			
		}
		
		

		
	</script>
		
	

</html>,