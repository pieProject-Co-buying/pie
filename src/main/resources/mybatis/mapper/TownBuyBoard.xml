<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.pie.pieProject.DAO.ITownBuyBoardDao">
	<select id="listDaoBoard"
		resultType="com.pie.pieProject.DTO.BoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id order
		by num desc
	</select>


	<select id="listDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id order
		by registDay desc

	</select>


	<!-- 조회순으로 보여주기 -->
	<select id="bestListDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		pie_townBuyBoard.addr_admin = #{param1} and
		process = 1
		order by hit
		desc
	</select>

	<!-- 좋아요 순으로 보여주기 -->
	<select id="likeListDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		pie_townBuyBoard.addr_admin = #{param1} and
		process = 1
		order by likeNum
		desc
	</select>

	<!-- 프리미엄 목록 -->
	<select id="listPremiumDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select * from (select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		pie_townBuyBoard.premium = 1 and
		pie_townBuyBoard.process = 1
		and
		pie_townBuyBoard.category = #{param1}
		and pie_townBuyBoard.addr_admin =
		#{param3} order by
		dbms_random.value)
		where rownum <![CDATA[ <= ]]>
		${param2}
	</select>


	<select id="viewDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		num = #{param1}
	</select>


	<!-- id로 내가쓴 게시글 불러오기 -->
	<select id="townListbyID"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where pie_townBuyBoard.id = #{param1}
	</select>


	<update id="updateDao">

		<!-- update pie_townBuyBoard set to_category = #{to_category}, to_title 
			= #{to_title}, to_content = #{to_content}, to_price = #{to_price}, to_personnelMax 
			= #{to_personnelMax}, to_deadLine = TO_DATE(#{to_deadLine}, 'YYYY-MM-DD') 
			where to_num = #{to_num} -->


		update pie_townBuyBoard set category=#{category},
		title=#{title},
		content=#{content},
		productImg=#{productImg}, tag=#{tag},
		deadLine=TO_DATE(#{deadLine}, 'YYYY-MM-DD'),
		personnelMax=#{personnelMax}, priceTotal=#{priceTotal},
		pricePer=#{pricePer}, ip=#{ip}, updateDay=sysdate,
		address =
		#{address},
		brand = #{brand},
		productName = #{productName}
		where
		num=#{num}

	</update>


	<delete id="deleteDao">

		delete pie_townBuyBoard where num = #{param1}

	</delete>

	<select id="searchDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		SELECT pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		FROM pie_member_user
		JOIN pie_townBuyBoard ON pie_townBuyBoard.id = pie_member_user.id
		WHERE (pie_townBuyBoard.title LIKE '%${param1}%'
		OR
		pie_townBuyBoard.content LIKE '%${param1}%'
		OR pie_townBuyBoard.tag
		LIKE '%${param1}%')
		AND pie_townBuyBoard.addr_admin = #{param2}
	</select>


	<select id="searchCateDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		SELECT pie_member_user.nickname,
		pie_member_user.profile_pic,
		pie_townBuyBoard.*
		FROM pie_member_user
		JOIN pie_townBuyBoard ON pie_townBuyBoard.id = pie_member_user.id
		WHERE category = #{param2}
		AND (title LIKE '%${param1}%'
		OR content LIKE '%${param1}%'
		OR tag LIKE '%${param1}%')
		AND pie_townBuyBoard.addr_admin = #{param3}
		ORDER BY num DESC
	</select>


	<select id="categoryDao"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		category = #{param1} and
		address like
		'${param2}%' order by num desc
	</select>

	<select id="categoryDaoNum"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select * from (select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		category =
		#{param1})
		where ROWNUM <![CDATA[ <= ]]>
		#{param2}
	</select>

	<insert id="writeDao">
		insert into pie_townBuyBoard values(
		piebr_num.nextval,
		#{id},
		#{category},
		#{premium},
		#{title},
		#{content},
		#{productImg},
		0,
		#{tag},
		#{address},
		#{addr_admin},
		'1',
		sysdate,
		sysdate,
		TO_DATE(#{deadLine},
		'YYYY-MM-DD'),
		#{personnelMax},
		1,
		#{priceTotal},
		#{pricePer},
		#{ip},
		0,
		#{brand},
		#{productName}
		)
	</insert>


	<select id="listLocal"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		pie_townBuyBoard.addr_admin = #{param1}
		order
		by num desc
	</select>

	<select id="listLocalActive"
		resultType="com.pie.pieProject.DTO.TownBuyBoardDto">
		select pie_member_user.nickname,
		pie_member_user.profile_pic, pie_townBuyBoard.*
		from pie_member_user
		JOIN pie_townBuyBoard ON
		pie_townBuyBoard.id
		=
		pie_member_user.id where
		pie_townBuyBoard.addr_admin = #{param1}
		and
		process= '1'
	</select>


	<update id="updatePer">
		update pie_townBuyBoard set personnelNow =
		personnelNow+1
		where num = #{param1}
	</update>

	<update id="updateProcess">
		update pie_townBuyBoard set process = 0 where num =
		#{param1}
	</update>


	<update id="updateHit">
		update pie_townBuyBoard set hit = hit+1 where
		num =
		#{param1}
	</update>

	<!-- 0시마다 마감체크 -->
	<update id="expireTownBuyBoard">
		UPDATE pie_townBuyBoard
		SET process = 3
		WHERE deadLine <![CDATA[ <= ]]>
		sysdate and personnelnow <![CDATA[ < ]]>
		personnelMax
	</update>


	<!-- 참여자수 증가 -->
	<update id="updatePersonnelNow">
		UPDATE pie_townBuyBoard
		SET personnelNow =
		personnelNow +
		1
		WHERE num = #{param1}
	</update>


	<!-- 진행상태 변경 -->
	<update id="updateTownProcess">
		UPDATE pie_townBuyBoard
		SET process = 0
		WHERE num =
		#{param1}
	</update>


	<!-- 참여자수 감소 -->
	<update id="canclePersonnelNow">
		UPDATE pie_townBuyBoard
		SET personnelNow =
		personnelNow - 1
		WHERE num = #{param1}
	</update>



</mapper>