<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pie.pieProject.DAO.IProxyBuyDao">
	<select id="listDaoBoard"
		resultType="com.pie.pieProject.DTO.BoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id order by num desc
	</select>
	<select id="listDao"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id order by num desc
	</select>
	<select id="listDaoByNewer"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id order by updateDay desc
	</select>
	<select id="listDaoByNewerNumber"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select * from ( select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id order by updateDay
		desc)
		where ROWNUM <![CDATA[ <= ]]>
		#{param1}
	</select>

	<select id="listDaoByFavorite"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select * from ( select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id order by likeNum desc,
		hit
		desc)
		where ROWNUM <![CDATA[ <= ]]>
		5
	</select>

	<select id="listDaoByNext"
		resultType="com.pie.pieProject.DTO.ScrollProxyBuyBoardDto">
		SELECT *
		FROM (
		SELECT t.*, ROW_NUMBER() OVER (ORDER BY
		num
		DESC) AS rnum
		FROM pie_proxyBuyBoard t
		)
		WHERE rnum BETWEEN #{param1}
		AND
		#{param2}
	</select>

	<select id="searchDao"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id where title like
		'%${param1}%'
		or
		content like '%${param1}%' or tag like
		'%${param1}%'
	</select>

	<select id="searchCateDao"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id where category = #{param2}
		and
		(title like
		'%${param1}%' or
		content like '%${param1}%' or
		tag like
		'%${param1}%')
	</select>

	<select id="listDaoByCategory"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id where category=#{param1}
		order
		by
		updateDay desc
	</select>
	<select id="listDaoByCategoryNumber"
		resultType="com.pie.pieProject.DTO.ProxyBuyBoardDto">
		select * from (select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id where category=#{param1}
		and process=1
		order by updateDay desc) where ROWNUM <![CDATA[ <= ]]>
		#{param2}
	</select>
	<select id="getView">
		select pie_member_user.nickname, pie_member_user.profile_pic, pie_proxyBuyBoard.* from pie_member_user JOIN pie_proxyBuyBoard ON pie_proxyBuyBoard.id= pie_member_user.id where num = #{param1}
	</select>
	<insert id="insertProxyBoard">
		insert into pie_proxyBuyBoard values(
		piebr_num.nextval,
		#{id},
		#{category},
		#{title},
		#{content},
		#{productImg},
		0,
		#{tag},
		'1',
		sysdate,
		sysdate,
		TO_DATE(#{deadLine},
		'YYYY-MM-DD'),
		#{personnelMax},
		1,
		#{priceTotal},
		#{pricePer},
		#{ip},
		0,
		#{brand},
		#{productName}
		)
	</insert>
	<update id="updateHit">
		update pie_proxyBuyBoard set hit = hit+1 where
		num =
		#{param1}
	</update>
	<update id="updateProxyBoard">
		update proxybuyboard set category=#{category},
		title=#{title},
		content=#{content},
		productImg=#{productImg},
		tag=#{tag},
		deadLine=TO_DATE(#{deadLine}, 'YYYY-MM-DD'),
		personnelMax=#{personnelMax},
		priceTotal=#{priceTotal},
		pricePer=#{pricePer}, ip=#{ip}, updateDay=sysdate,
		brand = #{brand},
		productName = #{productName}
		where
		num=#{num}

	</update>
	<delete id="deleteProxyBoard">
		delete pie_proxyBuyBoard where num = #{param1}
	</delete>
	<!-- 현재 인원 증가 -->
	<update id="updateNow">
		update pie_proxyBuyBoard set personnelNow =
		personnelNow +
		1 where num = #{param1}
	</update>
	<!-- -->
	<update id="maxChk">
		update pie_proxyBuyBoard set process = '0' where
		num =
		#{param1}
	</update>
	<!--환불시 인원 감소 -->
	<update id="refundNowPerson">
		update pie_proxyBuyBoard set personnelNow =
		personnelNow - 1 where num = #{param1}
	</update>
	<select id="chkFeed" resultType="_int">
		select count (id) from pie_makeFeed
		where id = #{param1}
	</select>
	<!-- 0시마다 마감체크 -->
	<update id="expireProxyBuyBoard">
		UPDATE pie_proxyBuyBoard
		SET process = 3
		WHERE deadLine <![CDATA[ <= ]]>
		sysdate and personnelnow <![CDATA[ < ]]> personnelMax
	</update>

</mapper>