<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/chatting}">

<div layout:fragment="chatContent" class="col">


	<div class="container-fluid p-0">








		<div class="container my-5">
		

			
			<div class="row mb-5">
				<div class="col text-center mb-5">
					<h1 class="text-center">함께해서 더 좋은 파이</h1>
					<div>
						제품에 대한 궁금한 점을 판매자와 소통가능! <br>
						팔로잉한 상대방과 언제나 소통가능! <br>
						나와의 채팅으로 기억하고 싶은 메세지 남겨놓기!
						
					</div>					
				</div>
			</div>
			
			<div class="row d-lg-none">
		
				<div class="col md-none">
					<div role="button" id="toggleFollowingList" onclick="toggleFollowingList()" class="badge badge-danger p-2 hj-radius-30">팔로잉</div>				
				</div>
		
			</div>
			

			<div class="row mb-3">
			


			
 				<div class="col-12 col-lg-4 mb-4 mb-lg-0">

					<div class="roomContainer border rounded shadow p-4 text-center hj-radius-30 d-none d-lg-block">
						<h2>팔로잉 목록</h2>
						<small>클릭 한 번으로</small><br />
						<small>팔로잉 멤버랑 대화하기</small>
						
						<th:block th:if="${fl!=null&&fl.size()!=0}">
						
							<ul class="list-unstyled mx-2 mt-3">
								<li th:each="f : ${fl}" class="border-bottom py-2">
									<a th:href="@{'room?mem='+${f.getId()}}" class="d-flex justify-content-start align-items-center mx-3"> <img
										th:src="@{'/imgs/profiles/'+${f.getProfile_pic()}}" alt=""
										class="pie-profilePic-mid mr-2" /><span
										th:text="${f.getNickname()}" class="ml-3"></span>
								</a>
								</li>
							</ul>

						</th:block>


					</div>



				</div>
 

				
				


				<div class="col-12 col-lg-8">





					<div id="roomContainer"
						class="roomContainer border rounded shadow p-4 hj-radius-30 ">
						
						<h2 class="mb-5 text-center">대화목록</h2>


						
						
						<!-- 값 테스트용 -->
						<input type="hidden" th:value="${session.userId}" id="nowLogin" />
						<input type="hidden" id="userId" th:value="${session.userId}">
						<input type="hidden" id="sessionId" th:value="${session.nickName}">
						<input type="hidden" id="roomNumber" th:value="${roomNumber}">
						<input type="hidden" id="mem1" th:value="${param.mem1}"> <input
							type="hidden" id="mem2" th:value="${param.mem2}"> <input
							type="hidden" id="sendDate" th:value="${sendDate}"> <input
							type="hidden" id="realNick" th:value="${session.nickName}">

<!-- 
			<th:block th:each="list:${tboard}"> -->
						<div id="roomList" class="roomList"></div>
						
						
<!-- 						<div th:text="${list.getTo_profileImg}"></div>
</th:block>						
 -->

					</div>

				</div>

				
			</div>


		</div>

	</div>


	<script type="text/javascript" th:inline="javascript">
		var you = /*[[${you}]]*/'';
		var me = /*[[${session.usernickName}]]*/'';
		console.log(you);
	</script>



	<script type="text/javascript" th:inline="javascript">
	
		/* const token = $("meta[name='_csrf']").attr("content") */
		/* const header = $("meta[name='_csrf_header']").attr("content"); */

		var ws;

		window.onload = function() {
			let id = $("#nowLogin").val()
			let nickName = $("#nowLoginName").val()
			createRoom();
		}

		
		
		function createRoom() {

			var msg = {
				mem1 : me,
				mem2 : you,
			};

			commonAjax('/createRoom', msg, 'post', function(result) {
				createChatingRoom(result);

			});

			$("#roomName").val("");
		}

		
		
		function goRoom(number) {
			location.href = "/moveChating?roomNumber=" + number;
			alert(name1 + name2)
		}

		
		
		function createChatingRoom(res) {
			
					
			var list = /*[[${member}]]*/[];
		

					
			
			if (res != null) {
				var tag = "";
				var sessionNick = $("#realNick").val(); // 현재 세션의 닉네임 가져오기
				
				
				res.forEach(function(d, idx) {
					console.log("d :" + d)
					
					var roomNumber = d.roomNumber;
					var nickName = d.nickname;
					var isMyChat = (sessionNick === nickName); // 현재 방이 나와의 채팅인지 확인
					
					/* console.log(d.userId); */
					
					
										
		           
		            var profileImg = "";
		            
					list.forEach(function(item) {

					    if (item.nickname === nickName) {
					        profileImg = item.profile_pic;
					     return;
					    }
					});

					tag += "<div role='button' class='row mb-3 justify-content-center mx-4' onclick='goRoom(\"" + roomNumber + "\")'>"	
				     + "<div class='room col-9')>"
				     + "<img src='imgs/profiles/" + profileImg + "' class='hj-chat-proImg mr-4'/>"
				     + "<span class='h6'>"
				     + (isMyChat ? nickName + "(나)" : nickName)
				     + "</span>"
				     + "</div>"
				     + "<div class='go col-3 text-center'>"
				     + (isMyChat ? "<div class='text-right'><svg xmlns='http://www.w3.org/2000/svg' width='25' height='25' fill='currentColor' class='bi bi-chat' viewBox='0 0 16 16'><path d='M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105'/></svg></div>"
				                : "<div class='text-right'><svg xmlns='http://www.w3.org/2000/svg' width='25' height='25' fill='currentColor' class='bi bi-chat' viewBox='0 0 16 16'><path d='M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105'/></svg></div>")
				     + "</div>" 
				     + "</div><hr />";					
					


								
					});


				$("#roomList").append(tag); // 방 목록 업데이트
			}
		}
		
		
		

		function commonAjax(url, parameter, type, calbak, contentType) {

			$.ajax({
				url : url,
				data : parameter,
				type : type,
				contentType : contentType != null ? contentType
						: 'application/x-www-form-urlencoded; charset=UTF-8',
				beforeSend : function(xhr) {
					xhr.setRequestHeader(header, token);
				},

				success : function(res) {
					calbak(res);
					console.log(res)
				},
				error : function(err) {
					console.log('error');
					calbak(err);
				}
			});
		}
		
		
		
		
	</script>
	
	
	<script>
		
		function toggleFollowingList() {
		    var followingList = document.querySelector('.roomContainer');
		    var button = document.getElementById('toggleFollowingList');
		    
		    if (followingList.classList.contains('d-none')) {
		        followingList.classList.remove('d-none');
		        followingList.classList.remove('d-lg-block');
		        followingList.classList.add('d-block');
		        button.classList.add('mb-4');
		        button.textContent = '접기';
		    } else {
		        followingList.classList.remove('d-block');
		        followingList.classList.add('d-none');
		        followingList.classList.add('d-lg-block');
		        button.classList.remove('mb-4');
		        button.textContent = '팔로잉';

		    }
		}
		
	</script>
	



</div>

</html>