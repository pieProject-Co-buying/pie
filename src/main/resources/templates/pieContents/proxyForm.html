<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/boardForm}">
<head>
<!-- include summernote css/js -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
	rel="stylesheet">
</head>


<!--<h1>Bootstrap 기본설정완료</h1>-->
<div layout:fragment="formContent" class="col">
	<!--------------------------------게시글 타이틀-------------------------------->
	<!--container-->
	<!--------------------------------게시글 로직-------------------------------->
	<div class="container">
		<div class="row">
			<div class="col">
				<form action="test" enctype="multipart/form-data" method="post"
					name="joinForm" onsubmit="getQuill()">
					<div class="form-group">
						<input type="text" class="form-control" id="exampleInputEmail1"
							aria-describedby="emailHelp" placeholder="제목" name="title">
					</div>
					<textarea rows="" cols="" class="d-none" id="quill_html"></textarea>
					<div class="form-group row">
						<div class="col">
							<div id="editor">
								<p>Hello World!</p>
								<p>
									Some initial <strong>bold</strong> text
								</p>
								<p>
									<br>
								</p>
							</div>
						</div>
					</div>
					<div class="form-group row justify-content-center mt-5">
						<div class="col-sm-9">
							<button type="button" class="btn btn-block pie-btn-red"
								id="joinBtn">등록</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!--게시글 로직 container-->
	<!--wrapper-->
	<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

	<!-- Initialize Quill editor -->
	<!-- <script>
		let toolbarOptions = [ [ {
			'header' : [ 1, 2, 3, 4, 5, 6, false ]
		} ], [ {
			'font' : []
		} ], [ {
			'align' : []
		} ], [ {
			'indent' : '-1'
		}, {
			'indent' : '+1'
		} ], [ 'bold', 'italic', 'underline', 'strike' ], // toggled buttons
		[ {
			'color' : []
		}, {
			'background' : []
		} ], // dropdown with defaults from theme
		[ {
			'list' : 'ordered'
		}, {
			'list' : 'bullet'
		} ], [ 'link', 'image' ], [ 'blockquote', 'code-block' ], ];

		let quill = new Quill('#editor', {
			modules : {
				toolbar : toolbarOptions
			},
			theme : 'snow'
		});
		
		quill.getModule('toolbar').addHandler('image', function () {
	        selectLocalImage();
	    });


		function selectLocalImage() {
		    const fileInput = document.createElement('input');
		    fileInput.setAttribute('type', 'file');
		    console.log("input.type " + fileInput.type);

		    fileInput.click();

		    fileInput.addEventListener("change", function () {  // change 이벤트로 input 값이 바뀌면 실행
		        const formData = new FormData();
		        const file = fileInput.files[0];
		        formData.append('uploadFile', file);

		        $.ajax({
		            type: 'post',
		            enctype: 'multipart/form-data',
		            url: 'imageUpload',
		            data: formData,
		            processData: false,
		            contentType: false,
		            dataType: 'json',
		            success: function (data) {
		                const range = quill.getSelection(); // 사용자가 선택한 에디터 범위
		                // uploadPath에 역슬래시(\) 때문에 경로가 제대로 인식되지 않는 것을 슬래시(/)로 변환
		                data.uploadPath = data.uploadPath.replace(/\\/g, '/');

		                quill.insertEmbed(range.index, 'image', "/board/display?fileName=" + data.uploadPath +"/"+ data.uuid +"_"+ data.fileName);
		                console.log("통신성공");
		            },
		            error: function (err) {
		                console.log(err);
		            }
		        });

		    });
		}

		$("#joinBtn").click(function() {
			getQuill();
		})

		function getQuill() {
			let quillContent = $("#editor .ql-editor").html();
			$("#content").html(quillContent);
			console.log(quillContent);
			return true;
		}
	</script> -->

	<script>
		function quilljsediterInit() {
			var option = {
				modules : {
					toolbar : [ [ {
						header : [ 1, 2, false ]
					} ], [ 'bold', 'italic', 'underline' ],
							[ 'image', 'code-block' ], [ {
								list : 'ordered'
							}, {
								list : 'bullet'
							} ] ]
				},
				placeholder : '자세한 내용을 입력해 주세요!',
				theme : 'snow'
			};

			quill = new Quill('#editor', option);
			quill
					.on(
							'text-change',
							function() {
								document.getElementById("quill_html").value = quill.root.innerHTML;
							});

			quill.getModule('toolbar').addHandler('image', function() {
				selectLocalImage();
			});
		}

		/* 이미지 콜백 함수 */

		function selectLocalImage() {
			const fileInput = document.createElement('input');
			fileInput.setAttribute('type', 'file');
			fileInput.setAttribute('name', 'boardImage');
			console.log("input.type " + fileInput.type);

			fileInput.click();

			fileInput.addEventListener("change", function() { // change 이벤트로 input 값이 바뀌면 실행
				const formData = new FormData();
				const file = fileInput.files[0];
				formData.append('uploadFile', file);

				$.ajax({
					type : 'post',
					enctype : 'multipart/form-data',
					url : 'imageUpload',
					data : formData,
					processData : false,
					contentType : false,
					dataType : 'json',
					success : function(data) {
						const range = quill.getSelection(); // 사용자가 선택한 에디터 범위
						data.uploadPath = data.uploadPath.replace(/\\/g, '/');
						quill
								.insertEmbed(range.index, 'image',
										"display?fileName="
												+ data.uploadPath + "/"
												+ data.uuid + "_"
												+ data.fileName);

					},
					error : function(err) {
						console.log(err);
					}
				});

			});
		}

		quilljsediterInit();
	</script>
</div>

</html>